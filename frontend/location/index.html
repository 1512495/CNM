<!DOCTYPE html>
<html>

<head>
    <title>Geocoding Service</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.1.1/socket.io.js"></script>
    <style>
        /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
        
        #map {
            height: 100%;
        }
        /* Optional: Makes the sample page fill the window. */
        
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        
        #floating-panel {
            position: absolute;
            top: 10px;
            left: 25%;
            z-index: 5;
            background-color: #fff;
            padding: 5px;
            border: 1px solid #999;
            text-align: center;
            font-family: 'Roboto', 'sans-serif';
            line-height: 30px;
            padding-left: 10px;
        }
    </style>
</head>

<body>
    <div id="floating-panel">
        <!-- <input id="address" type="textbox" value="Hồ Chí Minh">
        <input id="submit" type="button" value="Geocode"> -->
        <input id="update" type="button" value="Cập nhật tọa độ">
    </div>
    <div id="map" style="width: 400px;height: 400px;"></div>

    <div id="current">Đang định vị cho: </div>

    <table id="list" style="border: 5px;"></table>
    <script id="template" type="text/x-handlebars-template">
        <tr>
            <td>id</td>
            <td>Họ tên</td>
            <td>SĐT</td>
            <td>Địa chỉ</td>
            <td>Ghi chú</td>
            <td>Tình trạng</td>
            <td>#</td>
        </tr>
        {{#each this}}
        <tr>
            <td>{{id}}</td>
            <td>{{name}}</td>
            <td>{{phone}}</td>
            <td>{{address}}</td>
            <td>{{note}}</td>
            <td>{{status}}</td>
            <td> <input id="{{id}}" type="button" value="Chọn để định vị" onclick='DinhVi(id);'></td>
        </tr>
        {{/each}}
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.12/handlebars.min.js"></script>

    <script>
        let list;
        let current = null;
        function DinhVi(id) {
            for (let i = 0; i < list.length; i++) {
                if (list[i].id == id) {
                    current = list[i];
                    break;
                }
            }
            console.log(current);
            if (current) {
                $('#current').html("Đang định vị cho: " + current.name);
                $('#current').val(current.id);
                geocodeAddress(geocoder, map, current.address, current);
            }
        }

        var lat = null;
        var long = null;

        window.onload = function () {
            loadUser();
        }

        var socket = io('http://localhost:3000');
        socket.on('connection', function (msg) {
            console.log("Connected");
        });
        socket.on('new address added', (msg) => {
            axios.get('http://localhost:3000/request').then((response) => {
                loadUser();
            })
        });

        var loadUser = function () {
            document.getElementById('list').innerHTML = '';
            var url = 'http://localhost:3000/request';
            axios.get(url)
                .then(function (res) {
                    var source = document.getElementById('template').innerHTML;
                    var template = Handlebars.compile(source);
                    var html = template(res.data);
                    list = res.data;
                    document.getElementById('list').innerHTML += html;
                }).catch(function (err) {
                    console.log(err);
                }).then(function () {
                    //setTimeout(loadUser, 3500);
                })
        }
        var geocoder;
        var map;
        function initMap() {
            geocoder = new google.maps.Geocoder();
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 15,
                center: {
                    lat: 10.762622,
                    lng: 106.660172
                }
            });
            // document.getElementById('submit').addEventListener('click', function () {
            //     geocodeAddress(geocoder, map, "Hồ Chí Minh");
            // });

        }

        function geocodeAddress(geocoder, resultsMap, address, coor = null) {
            var latlng = null;
            if (coor) {
                latlng = { lat: parseFloat(current.latitude), lng: parseFloat(current.longitude) };
            }

            geocoder.geocode({
                'address': address
            }, function (results, status) {
                if (status === 'OK') {
                    //console.log(results[0].geometry.location.lat());
                    long = results[0].geometry.location.lng();
                    lat = results[0].geometry.location.lat();

                    resultsMap.setCenter(results[0].geometry.location);
                    var marker = new google.maps.Marker({
                        map: resultsMap,
                        draggable: true,
                        animation: google.maps.Animation.DROP,
                        position: results[0].geometry.location
                    });

                    google.maps.event.addListener(marker, 'dragend', function (event) {
                        console.log('final position is ' + event.latLng.lat() + ' / ' + event.latLng.lng());
                        lat = event.latLng.lat();
                        long = event.latLng.lng();
                    });

                } else {
                    alert('Geocode was not successful for the following reason: ' + status);
                }
            });
        }


        document.getElementById("update").addEventListener("click", function () {
            console.log("")
            axios.post('http://localhost:3000/request/update', {
                user_id: current.id,
                status: 1,
                lat: lat,
                long: long,
            })
                .then(function (response) {
                    console.log(response);
                    loadUser();
                })
                .catch(function (error) {
                    console.log(error);
                });
        });
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBl4QyHMxlZar0aVUVaJmEbqYV8TioCQLM&callback=initMap">
    </script>
</body>

</html>